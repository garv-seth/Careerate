name: Deploy Careerate to Azure Web App

# Trigger deployment on push to main branch
on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual deployment

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ›ï¸ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      run: npm ci

    - name: ğŸ—ï¸ Build application
      run: npm run build
      env:
        NODE_ENV: production

    - name: ğŸ§ª Run type checking
      run: npm run check

    - name: ğŸ“‹ Create deployment package
      run: |
        # Create deployment directory
        mkdir -p deployment
        
        # Copy built application
        cp -r dist deployment/
        
        # Copy necessary files for production
        cp package*.json deployment/
        cp web.config deployment/
        
        # Create deployment archive
        cd deployment
        zip -r ../careerate-deployment.zip .
        cd ..

    - name: ğŸš€ Deploy to Azure Web App
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ secrets.AZURE_WEBAPP_NAME }}
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
        package: careerate-deployment.zip

    - name: ğŸ” Health Check
      run: |
        # Wait for deployment to complete
        sleep 30
        
        # Check health endpoint
        curl -f https://${{ secrets.AZURE_WEBAPP_NAME }}.azurewebsites.net/health || {
          echo "Health check failed"
          exit 1
        }
        
        echo "âœ… Deployment successful and healthy"

    - name: ğŸ“± Notification
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "ğŸ‰ Careerate successfully deployed to Azure!"
          echo "ğŸŒ URL: https://${{ secrets.AZURE_WEBAPP_NAME }}.azurewebsites.net"
          echo "ğŸ” Health: https://${{ secrets.AZURE_WEBAPP_NAME }}.azurewebsites.net/health"
          echo "ğŸ¯ Dashboard: https://${{ secrets.AZURE_WEBAPP_NAME }}.azurewebsites.net/dashboard"
        else
          echo "âŒ Deployment failed"
        fi

# Environment variables that need to be configured in Azure Web App:
# - NODE_ENV=production
# - DATABASE_URL=postgresql://...
# - OPENAI_API_KEY=sk-...
# - AWS_ACCESS_KEY_ID=...
# - AWS_SECRET_ACCESS_KEY=...
# - GOOGLE_APPLICATION_CREDENTIALS=...
# - AZURE_CLIENT_ID=...
# - AZURE_CLIENT_SECRET=...
# - AZURE_TENANT_ID=...
# - SESSION_SECRET=...

# Required GitHub Secrets:
# - AZURE_WEBAPP_NAME: Your Azure Web App name
# - AZURE_WEBAPP_PUBLISH_PROFILE: Download from Azure Portal